name: Firebase CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: "20"
  BUILD_ARTIFACT: site-bundle
  BUILD_DIR: build-output

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Test
        run: npm test

      - name: Lint
        run: npm run lint

      - name: Prepare deployable artifact
        run: |
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"
          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "${BUILD_DIR}" \
            ./ "${BUILD_DIR}"/

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_ARTIFACT }}
          path: ${{ env.BUILD_DIR }}
          retention-days: 7

  deploy_staging:
    needs: build_and_test
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BUILD_ARTIFACT }}
          path: ${{ env.BUILD_DIR }}

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/firebase
            ~/.config/firebase
          key: ${{ runner.os }}-firebase-${{ hashFiles('firebase.json') }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase staging channel
        working-directory: ${{ env.BUILD_DIR }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_STAGING }}
        run: |
          firebase hosting:channel:deploy staging \
            --project staging \
            --token "${FIREBASE_TOKEN}" \
            --config ../firebase.json \
            --force

  deploy_production:
    needs: deploy_staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://ai-autonomous-coder-prod.web.app
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BUILD_ARTIFACT }}
          path: ${{ env.BUILD_DIR }}

      - name: Cache Firebase CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/firebase
            ~/.config/firebase
          key: ${{ runner.os }}-firebase-${{ hashFiles('firebase.json') }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase production
        working-directory: ${{ env.BUILD_DIR }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PRODUCTION }}
        run: |
          firebase deploy \
            --only hosting \
            --project production \
            --token "${FIREBASE_TOKEN}" \
            --config ../firebase.json \
            --non-interactive
