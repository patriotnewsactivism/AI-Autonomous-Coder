<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>AI Agent - Mobile Coding Assistant</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text: #e2e8f0;
      --text-dim: #94a3b8;
      --border: rgba(59, 130, 246, 0.2);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    /* App Container */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 100vw;
      overflow: hidden;
    }
    
    /* Top Header */
    .header {
      background: var(--bg-card);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
      animation: pulse 2s infinite;
    }
    
    .status-dot.running { background: var(--secondary); }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    
    .icon-btn:active {
      transform: scale(0.95);
      background: rgba(59, 130, 246, 0.2);
    }
    
    /* Main Content Area */
    .main-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Tab Views */
    .tab-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: 80px;
      -webkit-overflow-scrolling: touch;
    }
    
    .tab-view.active { display: flex; flex-direction: column; }
    
    /* Chat View */
    .messages {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .message {
      display: flex;
      gap: 0.75rem;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
    }
    
    .message.user {
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .message.system .message-avatar { background: linear-gradient(135deg, #8b5cf6, #a855f7); }
    .message.assistant .message-avatar { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .message.user .message-avatar { background: linear-gradient(135deg, #10b981, #059669); }
    
    .message-content {
      background: var(--bg-card);
      padding: 0.875rem;
      border-radius: 16px;
      max-width: 80%;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .message.user .message-content {
      background: var(--primary);
    }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    
    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Provider Cards */
    .provider-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .provider-card.selected {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
    }
    
    .provider-card:active {
      transform: scale(0.98);
    }
    
    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .provider-name {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .free-badge {
      background: var(--secondary);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .provider-info {
      font-size: 0.875rem;
      color: var(--text-dim);
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-dim);
    }
    
    .form-input {
      width: 100%;
      padding: 0.875rem;
      background: rgba(30, 41, 59, 0.6);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .form-input:focus {
      border-color: var(--primary);
    }
    
    .form-help {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 0.25rem;
    }
    
    .form-help a {
      color: var(--primary);
      text-decoration: none;
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #06b6d4);
      color: white;
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 2px solid var(--border);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--secondary), #059669);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Voice Button - Large and Central */
    .voice-fab {
      position: fixed;
      bottom: 80px;
      right: 1rem;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      border: none;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
      cursor: pointer;
      z-index: 90;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    
    .voice-fab:active {
      transform: scale(0.95);
    }
    
    .voice-fab.listening {
      animation: voicePulse 1s infinite;
      background: linear-gradient(135deg, var(--danger), #dc2626);
    }
    
    @keyframes voicePulse {
      0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4); }
      50% { transform: scale(1.1); box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6); }
    }
    
    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 0.75rem;
      z-index: 80;
    }
    
    .input-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .input-form input {
      flex: 1;
      padding: 0.875rem;
      background: rgba(30, 41, 59, 0.6);
      border: 2px solid var(--border);
      border-radius: 24px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
    }
    
    .input-form input:focus {
      border-color: var(--primary);
    }
    
    .send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    
    .send-btn:active {
      transform: scale(0.95);
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      z-index: 100;
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      padding: 0.5rem;
      color: var(--text-dim);
      font-size: 0.7rem;
      cursor: pointer;
      border: none;
      background: none;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item-icon {
      font-size: 1.5rem;
    }
    
    .nav-item:active {
      transform: scale(0.95);
    }
    
    /* Agent List */
    .agent-item {
      background: rgba(59, 130, 246, 0.1);
      padding: 0.875rem;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      border: 1px solid var(--border);
    }
    
    .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .agent-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .agent-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      background: var(--bg-card);
    }
    
    .agent-status.active {
      background: var(--secondary);
      color: white;
    }
    
    .agent-task {
      font-size: 0.875rem;
      color: var(--text-dim);
    }
    
    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .stat-card {
      background: rgba(59, 130, 246, 0.1);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--bg-dark);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--bg-dark);
      z-index: 10;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .modal-body {
      padding: 1rem;
      padding-bottom: 2rem;
    }
    
    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    /* Loading */
    .loading {
      display: inline-flex;
      gap: 0.25rem;
    }
    
    .loading-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      animation: loadingDot 1.4s infinite;
    }
    
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes loadingDot {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-dim);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .empty-state-text {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .empty-state-subtext {
      font-size: 0.875rem;
    }
    
    /* Utility Classes */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--bg-card);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 300;
      opacity: 0;
      transition: all 0.3s;
      max-width: 90%;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.error { border-color: var(--danger); }
    .toast.success { border-color: var(--secondary); }
    
    /* Install Prompt */
    .install-prompt {
      background: linear-gradient(135deg, var(--primary), #06b6d4);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .install-prompt-text {
      flex: 1;
      margin-right: 1rem;
    }
    
    .install-prompt-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .install-prompt-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
    }
    
    /* Responsive adjustments */
    @media (min-width: 768px) {
      .app { max-width: 480px; margin: 0 auto; }
      .bottom-nav { max-width: 480px; margin: 0 auto; left: 50%; transform: translateX(-50%); }
      .input-area { max-width: 480px; margin: 0 auto; left: 50%; transform: translateX(-50%); }
      .voice-fab { right: calc(50% - 240px + 1rem); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <span class="status-dot" id="statusDot"></span>
        <span id="headerTitle">AI Agent</span>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="settingsBtn" title="Settings">⚙️</button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Chat Tab -->
      <div class="tab-view active" id="chatTab">
        <div class="messages" id="messages"></div>
        
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon">💬</div>
          <div class="empty-state-text">Welcome to AI Agent!</div>
          <div class="empty-state-subtext">Tap the microphone to speak or type below</div>
        </div>
      </div>

      <!-- Agents Tab -->
      <div class="tab-view" id="agentsTab">
        <div class="card">
          <div class="card-title">🤖 Active Agents</div>
          <div id="agentsList"></div>
        </div>

        <div class="card">
          <div class="card-title">📊 Statistics</div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="completedCount">0</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="failedCount">0</div>
              <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="runningCount">0</div>
              <div class="stat-label">Running</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="costEstimate">$0.00</div>
              <div class="stat-label">Est. Cost</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-view" id="settingsTab">
        <div class="card">
          <div class="card-title">🤖 AI Provider</div>
          <div id="providersList"></div>
        </div>

        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your API key">
          <div class="form-help" id="apiKeyHelp"></div>
        </div>

        <button class="btn btn-primary" id="saveSettingsBtn">
          <span>💾</span>
          <span>Save Settings</span>
        </button>

        <div class="card mt-2">
          <div class="card-title">ℹ️ About</div>
          <div style="font-size: 0.875rem; color: var(--text-dim); line-height: 1.6;">
            <p><strong>Version:</strong> 2.0.0 Mobile</p>
            <p><strong>Build:</strong> Mobile-First</p>
            <p class="mt-1">Optimized for phone usage with voice control, multiple free AI providers, and instant setup.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Voice FAB Button -->
    <button class="voice-fab" id="voiceBtn" title="Voice Input">
      🎤
    </button>

    <!-- Input Area -->
    <div class="input-area">
      <form class="input-form" id="inputForm">
        <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off">
        <button type="submit" class="send-btn">➤</button>
      </form>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <button class="nav-item active" data-tab="chatTab">
        <div class="nav-item-icon">💬</div>
        <div>Chat</div>
      </button>
      <button class="nav-item" data-tab="agentsTab">
        <div class="nav-item-icon">🤖</div>
        <div>Agents</div>
      </button>
      <button class="nav-item" data-tab="settingsTab">
        <div class="nav-item-icon">⚙️</div>
        <div>Settings</div>
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // CONFIGURATION & STATE
    // ============================================
    
    const CONFIG = {
      provider: localStorage.getItem('provider') || 'gemini',
      apiKey: localStorage.getItem('apiKey') || '',
      isRunning: false,
      completedTasks: 0,
      failedTasks: 0,
      runningTasks: 0,
      totalCost: 0
    };

    // AI Provider Configurations
    const PROVIDERS = {
      gemini: {
        name: 'Google Gemini',
        emoji: '🔮',
        free: true,
        cost: 0,
        endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
        keyUrl: 'https://aistudio.google.com/app/apikey',
        info: 'FREE tier with generous limits. Best for mobile usage.'
      },
      huggingface: {
        name: 'HuggingFace',
        emoji: '🤗',
        free: true,
        cost: 0,
        endpoint: 'https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1',
        keyUrl: 'https://huggingface.co/settings/tokens',
        info: 'FREE inference API. Great for open source models.'
      },
      cohere: {
        name: 'Cohere',
        emoji: '🚀',
        free: true,
        cost: 0,
        endpoint: 'https://api.cohere.ai/v1/generate',
        keyUrl: 'https://dashboard.cohere.com/api-keys',
        info: 'FREE trial tier. Fast and affordable.'
      },
      together: {
        name: 'Together AI',
        emoji: '⚡',
        free: false,
        cost: 0.2,
        endpoint: 'https://api.together.xyz/inference',
        keyUrl: 'https://api.together.xyz/settings/api-keys',
        info: 'Affordable open source models. $0.20 per 1M tokens.'
      },
      claude: {
        name: 'Anthropic Claude',
        emoji: '🎭',
        free: false,
        cost: 3.0,
        endpoint: 'https://api.anthropic.com/v1/messages',
        keyUrl: 'https://console.anthropic.com',
        info: 'Premium AI with excellent reasoning. Paid only.'
      },
      openai: {
        name: 'OpenAI GPT',
        emoji: '🤖',
        free: false,
        cost: 0.15,
        endpoint: 'https://api.openai.com/v1/chat/completions',
        keyUrl: 'https://platform.openai.com/api-keys',
        info: 'Industry standard. GPT-4o Mini is affordable.'
      }
    };

    // Agent Types
    const AGENT_TYPES = {
      CODE_GENERATOR: { name: 'Code Generator', emoji: '💻', role: 'Writes code' },
      CODE_ANALYZER: { name: 'Code Analyzer', emoji: '🔍', role: 'Reviews code' },
      DEBUGGER: { name: 'Debugger', emoji: '🐛', role: 'Fixes bugs' },
      TESTING: { name: 'Testing Agent', emoji: '🧪', role: 'Creates tests' },
      DOCUMENTATION: { name: 'Docs Writer', emoji: '📝', role: 'Writes docs' }
    };

    // State
    const STATE = {
      agents: Object.keys(AGENT_TYPES).map(key => ({
        ...AGENT_TYPES[key],
        id: key,
        isActive: false,
        tasksCompleted: 0
      })),
      messages: [],
      currentTab: 'chatTab'
    };

    // Voice Recognition
    let recognition = null;
    let isListening = false;

    // ============================================
    // DOM ELEMENTS
    // ============================================
    
    const elements = {
      messages: document.getElementById('messages'),
      emptyState: document.getElementById('emptyState'),
      userInput: document.getElementById('userInput'),
      inputForm: document.getElementById('inputForm'),
      voiceBtn: document.getElementById('voiceBtn'),
      statusDot: document.getElementById('statusDot'),
      headerTitle: document.getElementById('headerTitle'),
      settingsBtn: document.getElementById('settingsBtn'),
      providersList: document.getElementById('providersList'),
      apiKeyInput: document.getElementById('apiKeyInput'),
      apiKeyHelp: document.getElementById('apiKeyHelp'),
      saveSettingsBtn: document.getElementById('saveSettingsBtn'),
      agentsList: document.getElementById('agentsList'),
      completedCount: document.getElementById('completedCount'),
      failedCount: document.getElementById('failedCount'),
      runningCount: document.getElementById('runningCount'),
      costEstimate: document.getElementById('costEstimate'),
      toast: document.getElementById('toast')
    };

    // ============================================
    // INITIALIZATION
    // ============================================

    function init() {
      // Setup voice recognition
      setupVoiceRecognition();
      
      // Setup event listeners
      setupEventListeners();
      
      // Render providers
      renderProviders();
      
      // Render agents
      renderAgents();
      
      // Update UI
      updateStatus();
      
      // Show welcome message
      if (!CONFIG.apiKey) {
        addMessage('system', '👋 Welcome! Please configure your AI provider in Settings to get started.');
        showToast('Configure your AI provider to start', 'error');
      } else {
        CONFIG.isRunning = true;
        addMessage('system', `✨ ${PROVIDERS[CONFIG.provider].name} is ready! Tap the microphone or type to start.`);
        updateStatus();
      }

      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      }

      // Check for install prompt
      checkInstallPrompt();
    }

    // ============================================
    // VOICE RECOGNITION
    // ============================================

    function setupVoiceRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
          isListening = true;
          elements.voiceBtn.classList.add('listening');
          elements.voiceBtn.textContent = '🔴';
          showToast('Listening... Speak now', 'success');
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          elements.userInput.value = transcript;
          showToast(`Heard: "${transcript}"`, 'success');
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          showToast(`Voice error: ${event.error}`, 'error');
        };

        recognition.onend = () => {
          isListening = false;
          elements.voiceBtn.classList.remove('listening');
          elements.voiceBtn.textContent = '🎤';
        };
      } else {
        showToast('Voice recognition not supported on this device', 'error');
      }
    }

    function toggleVoice() {
      if (!recognition) {
        showToast('Voice recognition not available', 'error');
        return;
      }

      if (isListening) {
        recognition.stop();
      } else {
        try {
          recognition.start();
        } catch (error) {
          console.error('Failed to start recognition:', error);
          showToast('Failed to start voice recognition', 'error');
        }
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    function setupEventListeners() {
      // Voice button
      elements.voiceBtn.addEventListener('click', toggleVoice);

      // Input form
      elements.inputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = elements.userInput.value.trim();
        if (!query) return;

        if (!CONFIG.apiKey) {
          showToast('Please configure your API key first', 'error');
          switchTab('settingsTab');
          return;
        }

        elements.userInput.value = '';
        await handleUserMessage(query);
      });

      // Settings button
      elements.settingsBtn.addEventListener('click', () => {
        switchTab('settingsTab');
      });

      // Save settings
      elements.saveSettingsBtn.addEventListener('click', saveSettings);

      // Tab navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const tab = item.dataset.tab;
          switchTab(tab);
        });
      });

      // API key input
      elements.apiKeyInput.value = CONFIG.apiKey;
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================

    function addMessage(type, content) {
      elements.emptyState.classList.add('hidden');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'user' ? '👤' : type === 'system' ? '⚙️' : '🤖';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = content;
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      
      elements.messages.appendChild(messageDiv);
      elements.messages.scrollTop = elements.messages.scrollHeight;
      
      STATE.messages.push({ type, content, timestamp: Date.now() });
    }

    function showToast(message, type = 'info') {
      elements.toast.textContent = message;
      elements.toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, 3000);
    }

    function switchTab(tabId) {
      // Update tabs
      document.querySelectorAll('.tab-view').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');

      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.tab === tabId) {
          item.classList.add('active');
        }
      });

      STATE.currentTab = tabId;

      // Update agents if on agents tab
      if (tabId === 'agentsTab') {
        renderAgents();
        updateStats();
      }
    }

    function updateStatus() {
      if (CONFIG.isRunning) {
        elements.statusDot.classList.add('running');
        elements.headerTitle.textContent = PROVIDERS[CONFIG.provider].emoji + ' ' + PROVIDERS[CONFIG.provider].name;
      } else {
        elements.statusDot.classList.remove('running');
        elements.headerTitle.textContent = 'AI Agent';
      }
    }

    function renderProviders() {
      elements.providersList.innerHTML = '';
      
      Object.keys(PROVIDERS).forEach(key => {
        const provider = PROVIDERS[key];
        const card = document.createElement('div');
        card.className = 'provider-card' + (CONFIG.provider === key ? ' selected' : '');
        card.onclick = () => selectProvider(key);
        
        card.innerHTML = `
          <div class="provider-header">
            <div class="provider-name">${provider.emoji} ${provider.name}</div>
            ${provider.free ? '<div class="free-badge">FREE</div>' : ''}
          </div>
          <div class="provider-info">${provider.info}</div>
        `;
        
        elements.providersList.appendChild(card);
      });

      updateApiKeyHelp();
    }

    function selectProvider(providerId) {
      CONFIG.provider = providerId;
      renderProviders();
      updateApiKeyHelp();
    }

    function updateApiKeyHelp() {
      const provider = PROVIDERS[CONFIG.provider];
      elements.apiKeyHelp.innerHTML = `
        <a href="${provider.keyUrl}" target="_blank">Get ${provider.name} API key →</a>
      `;
    }

    function renderAgents() {
      elements.agentsList.innerHTML = '';
      
      STATE.agents.forEach(agent => {
        const div = document.createElement('div');
        div.className = 'agent-item';
        
        div.innerHTML = `
          <div class="agent-header">
            <div class="agent-name">
              ${agent.emoji} ${agent.name}
            </div>
            <div class="agent-status ${agent.isActive ? 'active' : ''}">
              ${agent.isActive ? '🟢 Active' : '⚪ Idle'}
            </div>
          </div>
          <div class="agent-task">${agent.role} • ${agent.tasksCompleted} completed</div>
        `;
        
        elements.agentsList.appendChild(div);
      });
    }

    function updateStats() {
      elements.completedCount.textContent = CONFIG.completedTasks;
      elements.failedCount.textContent = CONFIG.failedTasks;
      elements.runningCount.textContent = CONFIG.runningTasks;
      elements.costEstimate.textContent = '$' + CONFIG.totalCost.toFixed(4);
    }

    function saveSettings() {
      CONFIG.apiKey = elements.apiKeyInput.value.trim();
      
      if (!CONFIG.apiKey) {
        showToast('Please enter an API key', 'error');
        return;
      }

      localStorage.setItem('provider', CONFIG.provider);
      localStorage.setItem('apiKey', CONFIG.apiKey);
      
      CONFIG.isRunning = true;
      updateStatus();
      
      showToast('Settings saved! Ready to use', 'success');
      
      switchTab('chatTab');
      
      addMessage('system', `✅ ${PROVIDERS[CONFIG.provider].name} configured successfully! Try saying "Create a login form" or type your request.`);
    }

    // ============================================
    // AI INTEGRATION
    // ============================================

    async function handleUserMessage(query) {
      addMessage('user', query);
      showToast('Processing...', 'info');

      try {
        CONFIG.runningTasks = 1;
        updateStats();

        const response = await callAI(query);
        
        addMessage('assistant', response);
        
        CONFIG.completedTasks++;
        CONFIG.runningTasks = 0;
        updateStats();
        
        showToast('Response received!', 'success');
      } catch (error) {
        console.error('AI call failed:', error);
        addMessage('system', `❌ Error: ${error.message}`);
        CONFIG.failedTasks++;
        CONFIG.runningTasks = 0;
        updateStats();
        showToast('Failed to get response', 'error');
      }
    }

    async function callAI(prompt) {
      const provider = PROVIDERS[CONFIG.provider];
      
      const systemPrompt = `You are a helpful AI coding assistant. Provide clear, concise, and practical responses. When writing code, include explanations.`;

      // API call logic based on provider
      switch (CONFIG.provider) {
        case 'gemini':
          return await callGemini(prompt, systemPrompt);
        case 'huggingface':
          return await callHuggingFace(prompt, systemPrompt);
        case 'cohere':
          return await callCohere(prompt, systemPrompt);
        case 'together':
          return await callTogether(prompt, systemPrompt);
        case 'claude':
          return await callClaude(prompt, systemPrompt);
        case 'openai':
          return await callOpenAI(prompt, systemPrompt);
        default:
          throw new Error('Invalid provider');
      }
    }

    async function callGemini(prompt, systemPrompt) {
      const url = `${PROVIDERS.gemini.endpoint}?key=${CONFIG.apiKey}`;
      
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            role: 'user',
            parts: [{ text: systemPrompt + '\n\n' + prompt }]
          }]
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'Gemini API call failed');
      }

      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    }

    async function callHuggingFace(prompt, systemPrompt) {
      const response = await fetch(PROVIDERS.huggingface.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${CONFIG.apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          inputs: systemPrompt + '\n\n' + prompt,
          parameters: { max_new_tokens: 500, temperature: 0.7 }
        })
      });

      if (!response.ok) {
        throw new Error('HuggingFace API call failed');
      }

      const data = await response.json();
      return Array.isArray(data) ? data[0].generated_text : data.generated_text;
    }

    async function callCohere(prompt, systemPrompt) {
      const response = await fetch(PROVIDERS.cohere.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${CONFIG.apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prompt: systemPrompt + '\n\n' + prompt,
          max_tokens: 500,
          temperature: 0.7
        })
      });

      if (!response.ok) {
        throw new Error('Cohere API call failed');
      }

      const data = await response.json();
      return data.generations[0].text;
    }

    async function callTogether(prompt, systemPrompt) {
      const response = await fetch(PROVIDERS.together.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${CONFIG.apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'mistralai/Mixtral-8x7B-Instruct-v0.1',
          prompt: systemPrompt + '\n\n' + prompt,
          max_tokens: 500,
          temperature: 0.7
        })
      });

      if (!response.ok) {
        throw new Error('Together AI call failed');
      }

      const data = await response.json();
      return data.output.choices[0].text;
    }

    async function callClaude(prompt, systemPrompt) {
      const response = await fetch(PROVIDERS.claude.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': CONFIG.apiKey,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          system: systemPrompt,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) {
        throw new Error('Claude API call failed');
      }

      const data = await response.json();
      return data.content[0].text;
    }

    async function callOpenAI(prompt, systemPrompt) {
      const response = await fetch(PROVIDERS.openai.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${CONFIG.apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: prompt }
          ]
        })
      });

      if (!response.ok) {
        throw new Error('OpenAI API call failed');
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    // ============================================
    // PWA FEATURES
    // ============================================

    let deferredPrompt;

    function checkInstallPrompt() {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallPrompt();
      });
    }

    function showInstallPrompt() {
      const installPrompt = document.createElement('div');
      installPrompt.className = 'install-prompt';
      installPrompt.innerHTML = `
        <div class="install-prompt-text">
          <div class="install-prompt-title">📱 Install App</div>
          <div class="install-prompt-subtitle">Add to home screen for quick access</div>
        </div>
        <button class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;" id="installBtn">
          Install
        </button>
      `;

      document.getElementById('chatTab').insertBefore(installPrompt, document.getElementById('messages'));

      document.getElementById('installBtn').addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            showToast('App installed successfully!', 'success');
          }
          deferredPrompt = null;
          installPrompt.remove();
        }
      });
    }

    // ============================================
    // START APPLICATION
    // ============================================

    init();
  </script>
</body>
</html>
