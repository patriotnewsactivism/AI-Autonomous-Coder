<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>AI Worker Plus</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <style>
    body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: #0f172a; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }
    #root { height: 100%; width: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js" defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // All deferred scripts are loaded. We can now safely run the app.
        const e = React.createElement;
        const { useState, useEffect, useRef } = React;
        
        // This is the line that was failing. It should now work.
        const { 
          Send, Mic, MicOff, Settings, Bot, Code, User, Github, 
          PlayCircle, PauseCircle, FileCode, Loader, CheckCircle, XCircle, 
          AlertCircle, Menu, X, Zap, ChevronDown, ChevronUp, Save 
        } = lucide; 

        // --- Start of App Code ---

        const useWindowSize = () => {
          const [windowSize, setWindowSize] = useState({ width: window.innerWidth, height: window.innerHeight });
          useEffect(() => {
            const handleResize = () => setWindowSize({ width: window.innerWidth, height: window.innerHeight });
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
          }, []);
          return windowSize;
        };

        function App() {
          const { width } = useWindowSize();
          const [messages, setMessages] = useState([]);
          const [inputValue, setInputValue] = useState('');
          const [isProcessing, setIsProcessing] = useState(false);
          const [aiName, setAiName] = useState('Assistant');
          const [apiKey, setApiKey] = useState('');
          const [showSettings, setShowSettings] = useState(false);
          const [showSidebar, setShowSidebar] = useState(false);
          const [expandedSections, setExpandedSections] = useState({ files: true, actions: true });
          const [githubToken, setGithubToken] = useState('');
          const [githubRepo, setGithubRepo] = useState('');
          const [githubBranch, setGithubBranch] = useState('main');
          const [repoFiles, setRepoFiles] = useState([]);
          const [syncStatus, setSyncStatus] = useState('idle');
          const [isListening, setIsListening] = useState(false);
          const [autopilotMode, setAutopilotMode] = useState(false);
          const [currentTask, setCurrentTask] = useState('');
          const [taskQueue, setTaskQueue] = useState([]);
          const [installPrompt, setInstallPrompt] = useState(null);
          const [isInstalled, setIsInstalled] = useState(false);
          const messagesEndRef = useRef(null);
          const recognitionRef = useRef(null);
          const autopilotIntervalRef = useRef(null);

          const addMessage = (type, content) => {
            const message = { id: Date.now() + Math.random(), type, content, timestamp: new Date().toLocaleTimeString() };
            setMessages(prev => [...prev, message]);
          };
          
          useEffect(() => {
            const handleBeforeInstallPrompt = (e) => { e.preventDefault(); setInstallPrompt(e); };
            window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            if (window.matchMedia('(display-mode: standalone)').matches) { setIsInstalled(true); }
            return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
          }, []);

          const handleInstallPWA = async () => {
            if (!installPrompt) return;
            installPrompt.prompt();
            const { outcome } = await installPrompt.userChoice;
            if (outcome === 'accepted') { setIsInstalled(true); addMessage('ai', '✅ App installed!'); }
            setInstallPrompt(null);
          };
          
          useEffect(() => {
            const savedConfig = localStorage.getItem('aiWorkerConfig');
            if (savedConfig) {
              try {
                const config = JSON.parse(savedConfig);
                setAiName(config.aiName || 'Assistant');
                setApiKey(config.apiKey || '');
                setGithubToken(config.githubToken || '');
                setGithubRepo(config.githubRepo || '');
                setGithubBranch(config.githubBranch || 'main');
              } catch (error) { console.error('Error loading config:', error); }
            }
            setMessages([{
              id: Date.now(),
              type: 'ai',
              content: `# ⚡ AI Worker Plus\n\n**Quick Start:**\n\n1. Tap ⚙️ to configure your API keys.\n2. Use 🎤 for voice commands.\n3. Enable 🤖 for autonomous tasks.`,
              timestamp: new Date().toLocaleTimeString()
            }]);
          }, []);

          useEffect(() => {
            const config = { aiName, apiKey, githubToken, githubRepo, githubBranch };
            localStorage.setItem('aiWorkerConfig', JSON.stringify(config));
          }, [aiName, apiKey, githubToken, githubRepo, githubBranch]);

          useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

          const processUserInput = async (input) => {
            if (!apiKey) {
                addMessage('ai', '❌ **API Key Required**\n\nPlease add your Gemini API key in settings (⚙️).');
                return;
            }
            setIsProcessing(true);
            try {
                const prompt = `You are ${aiName}, an expert AI coding assistant. User request: ${input}. Provide a helpful, detailed response. If the request involves code, provide complete, working code with explanations.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                const data = await response.json();
                addMessage('ai', data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response generated.');
            } catch (error) {
                addMessage('ai', `❌ Error: ${error.message}`);
            } finally {
                setIsProcessing(false);
            }
          };

          const handleSubmit = async (ev) => {
              ev.preventDefault();
              if (!inputValue.trim() || isProcessing) return;
              const userInput = inputValue;
              setInputValue('');
              addMessage('user', userInput);
              await processUserInput(userInput);
          };
          
          const toggleSection = (section) => setExpandedSections(prev => ({...prev, [section]: !prev[section]}));
          const toggleAutopilot = () => setAutopilotMode(!autopilotMode);

          const getSyncStatusIcon = () => {
            switch (syncStatus) {
              case 'syncing': return e(Loader, { className: "spin", size: 16 });
              case 'success': return e(CheckCircle, { size: 16 });
              case 'error': return e(XCircle, { size: 16 });
              default: return e(AlertCircle, { size: 16 });
            }
          };

          return e('div', { style: { height: '100dvh', display: 'flex', flexDirection: 'column', background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', overflow: 'hidden' } },
            e('header', { style: { background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(10px)', padding: 'clamp(0.75rem, 4vw, 1rem) clamp(1rem, 4vw, 2rem)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid rgba(59, 130, 246, 0.2)', boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)', position: 'sticky', top: 0, zIndex: 100 } },
              e('div', { style: { display: 'flex', alignItems: 'center', gap: 'clamp(0.5rem, 2vw, 1rem)' } },
                e('div', { style: { width: 'clamp(32px, 8vw, 40px)', height: 'clamp(32px, 8vw, 40px)', background: 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 0 20px rgba(59, 130, 246, 0.5)', position: 'relative' } },
                  e(Zap, { color: "white", size: width < 768 ? 18 : 24, strokeWidth: 2.5 }),
                  e('div', { style: { position: 'absolute', inset: 0, borderRadius: '10px', background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(6, 182, 212, 0.3) 100%)', filter: 'blur(8px)', zIndex: -1 } })
                ),
                e('h1', { style: { color: 'white', margin: 0, fontSize: 'clamp(1rem, 4vw, 1.5rem)', fontWeight: '700', letterSpacing: '-0.02em' } }, 'AI Worker', e('span', { style: { color: '#3b82f6', marginLeft: '0.25rem' } }, 'Plus'))
              ),
              e('div', { style: { display: 'flex', gap: 'clamp(0.5rem, 2vw, 1rem)', alignItems: 'center' } },
                e('button', { onClick: () => setShowSidebar(!showSidebar), style: { background: 'rgba(59, 130, 246, 0.1)', color: '#3b82f6', border: '1px solid rgba(59, 130, 246, 0.3)', padding: 'clamp(0.5rem, 2vw, 0.6rem)', borderRadius: '8px', cursor: 'pointer', display: width < 1024 ? 'flex' : 'none', alignItems: 'center', justifyContent: 'center', touchAction: 'manipulation' } },
                  showSidebar ? e(X, { size: 20 }) : e(Menu, { size: 20 })
                ),
                e('button', { onClick: toggleAutopilot, style: { background: autopilotMode ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'rgba(59, 130, 246, 0.1)', color: 'white', border: autopilotMode ? 'none' : '1px solid rgba(59, 130, 246, 0.3)', padding: 'clamp(0.5rem, 2vw, 0.6rem) clamp(0.75rem, 3vw, 1rem)', borderRadius: '8px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: 'clamp(0.8rem, 2.5vw, 0.9rem)', fontWeight: '600', touchAction: 'manipulation', whiteSpace: 'nowrap' } },
                  autopilotMode ? e(PauseCircle, { size: 16 }) : e(PlayCircle, { size: 16 }),
                  e('span', { style: { display: width < 640 ? 'none' : 'inline' } }, autopilotMode ? 'ON' : 'OFF')
                ),
                e('div', { style: { background: 'rgba(59, 130, 246, 0.1)', padding: 'clamp(0.5rem, 2vw, 0.6rem) clamp(0.75rem, 3vw, 1rem)', borderRadius: '8px', display: 'flex', alignItems: 'center', gap: '0.5rem', border: '1px solid rgba(59, 130, 246, 0.3)' } },
                  getSyncStatusIcon(),
                  e('span', { style: { color: '#94a3b8', fontSize: 'clamp(0.75rem, 2.5vw, 0.9rem)', display: width < 480 ? 'none' : 'inline' } }, githubRepo ? githubRepo.split('/')[1] : 'No Repo')
                ),
                e('button', { onClick: () => setShowSettings(true), style: { background: 'rgba(59, 130, 246, 0.1)', color: '#3b82f6', border: '1px solid rgba(59, 130, 246, 0.3)', padding: 'clamp(0.5rem, 2vw, 0.6rem)', borderRadius: '8px', cursor: 'pointer', display: 'flex', alignItems: 'center', touchAction: 'manipulation' } },
                  e(Settings, { size: 20 })
                )
              )
            ),
            e('div', { style: { flex: 1, display: 'flex', overflow: 'hidden', position: 'relative' } },
              showSidebar && width < 1024 && e('div', { onClick: () => setShowSidebar(false), style: { position: 'fixed', inset: 0, background: 'rgba(0, 0, 0, 0.5)', zIndex: 200, backdropFilter: 'blur(2px)' } }),
              e('div', { style: { width: width < 1024 ? '80%' : '300px', maxWidth: '320px', background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(10px)', padding: '1rem', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '1rem', borderRight: '1px solid rgba(59, 130, 246, 0.2)', position: width < 1024 ? 'fixed' : 'relative', left: width < 1024 ? (showSidebar ? 0 : '-100%') : 0, top: width < 1024 ? '65px' : 0, bottom: 0, zIndex: 300, transition: 'left 0.3s ease-in-out', WebkitOverflowScrolling: 'touch' } },
                installPrompt && !isInstalled && e('div', { style: { background: 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)', borderRadius: '12px', padding: '1rem', boxShadow: '0 4px 12px rgba(59, 130, 246, 0.3)' } },
                  e('h4', { style: { margin: '0 0 0.5rem 0', color: 'white', fontSize: '0.9rem', fontWeight: '600' } }, '📱 Install App'),
                  e('p', { style: { margin: '0 0 0.75rem 0', fontSize: '0.8rem', color: 'rgba(255, 255, 255, 0.9)', lineHeight: '1.4' } }, 'Add to home screen for quick access!'),
                  e('button', { onClick: handleInstallPWA, style: { width: '100%', background: 'rgba(255, 255, 255, 0.2)', color: 'white', border: '1px solid rgba(255, 255, 255, 0.3)', padding: '0.5rem', borderRadius: '6px', cursor: 'pointer', fontSize: '0.85rem', fontWeight: '600', touchAction: 'manipulation' } }, 'Install Now')
                ),
                e('div', { style: { background: 'rgba(59, 130, 246, 0.05)', borderRadius: '12px', padding: '1rem', border: '1px solid rgba(59, 130, 246, 0.2)' } },
                  e('button', { onClick: () => toggleSection('actions'), style: { width: '100%', background: 'none', border: 'none', padding: 0, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: expandedSections.actions ? '1rem' : 0, touchAction: 'manipulation' } },
                    e('h3', { style: { color: '#e2e8f0', margin: 0, fontSize: '1rem', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' } }, e(Code, { size: 16 }), 'Quick Actions'),
                    expandedSections.actions ? e(ChevronUp, { size: 18, color: "#94a3b8" }) : e(ChevronDown, { size: 18, color: "#94a3b8" })
                  ),
                  expandedSections.actions && e('div', { style: { display: 'flex', flexDirection: 'column', gap: '0.5rem' } },
                    e('button', { onClick: () => { setInputValue('Create a React component'); setShowSidebar(false); }, style: { background: 'rgba(59, 130, 246, 0.1)', color: '#e2e8f0', border: '1px solid rgba(59, 130, 246, 0.2)', padding: '0.75rem', borderRadius: '6px', cursor: 'pointer', fontSize: '0.85rem', textAlign: 'left', fontWeight: '500', touchAction: 'manipulation' } }, '⚛️ Create React Component'),
                    e('button', { onClick: () => { setInputValue('Fetch GitHub repository'); setShowSidebar(false); }, style: { background: 'rgba(59, 130, 246, 0.1)', color: '#e2e8f0', border: '1px solid rgba(59, 130, 246, 0.2)', padding: '0.75rem', borderRadius: '6px', cursor: 'pointer', fontSize: '0.85rem', textAlign: 'left', fontWeight: '500', touchAction: 'manipulation' } }, '🔗 Sync with GitHub')
                  )
                )
              ),
              e('div', { style: { flex: 1, display: 'flex', flexDirection: 'column', background: 'rgba(30, 41, 59, 0.5)', margin: width < 768 ? '0.5rem' : '1rem', marginLeft: width < 1024 ? (width < 768 ? '0.5rem' : '1rem') : '0', borderRadius: width < 768 ? '12px' : '16px', overflow: 'hidden', boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)', border: '1px solid rgba(59, 130, 246, 0.2)' } },
                e('div', { style: { flex: 1, overflowY: 'auto', padding: width < 768 ? '1rem' : '2rem', display: 'flex', flexDirection: 'column', gap: width < 768 ? '0.75rem' : '1rem', WebkitOverflowScrolling: 'touch' } },
                  messages.map(msg => e('div', { key: msg.id, style: { display: 'flex', gap: width < 768 ? '0.5rem' : '1rem', alignItems: 'flex-start', flexDirection: msg.type === 'user' ? 'row-reverse' : 'row', maxWidth: '100%' } },
                    e('div', { style: { width: width < 768 ? '32px' : '40px', height: width < 768 ? '32px' : '40px', borderRadius: '50%', background: msg.type === 'ai' ? 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 } },
                      msg.type === 'ai' ? e(Bot, { color: "white", size: width < 768 ? 16 : 20 }) : e(User, { color: "white", size: width < 768 ? 16 : 20 })
                    ),
                    e('div', { style: { flex: 1, background: msg.type === 'ai' ? 'rgba(51, 65, 85, 0.6)' : 'rgba(59, 130, 246, 0.2)', color: msg.type === 'ai' ? '#e2e8f0' : '#ffffff', padding: width < 768 ? '0.75rem' : '1rem', borderRadius: '12px', maxWidth: width < 768 ? '85%' : '70%', border: `1px solid rgba(59, 130, 246, ${msg.type === 'ai' ? '0.2' : '0.3'})`, backdropFilter: 'blur(10px)', wordBreak: 'break-word', whiteSpace: 'pre-wrap' } },
                      msg.content,
                      e('div', { style: { fontSize: width < 768 ? '0.7rem' : '0.75rem', opacity: 0.6, marginTop: '0.5rem' } }, msg.timestamp)
                    )
                  )),
                  e('div', { ref: messagesEndRef })
                ),
                currentTask && e('div', { style: { background: 'rgba(251, 191, 36, 0.1)', padding: width < 768 ? '0.6rem 1rem' : '0.75rem 2rem', borderTop: '1px solid rgba(251, 191, 36, 0.3)', fontSize: width < 768 ? '0.85rem' : '0.9rem', color: '#fbbf24', display: 'flex', alignItems: 'center', gap: '0.5rem' } },
                  e(Loader, { className: "spin", size: 14 }),
                  e('span', {}, `Processing: ${currentTask.substring(0, 50)}${currentTask.length > 50 ? '...' : ''}`)
                ),
                e('form', { onSubmit: handleSubmit, style: { padding: width < 768 ? '1rem' : '1.5rem 2rem', borderTop: '1px solid rgba(59, 130, 246, 0.2)', background: 'rgba(15, 23, 42, 0.8)', backdropFilter: 'blur(10px)' } },
                  e('div', { style: { display: 'flex', gap: width < 768 ? '0.5rem' : '1rem', alignItems: 'center' } },
                    e('button', { type: "button", onClick: () => console.log('Mic clicked'), disabled: isProcessing, style: { background: isListening ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)', color: 'white', border: 'none', padding: width < 768 ? '0.7rem' : '0.75rem', borderRadius: '50%', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', opacity: isProcessing ? 0.5 : 1 } },
                      isListening ? e(MicOff, { size: width < 768 ? 18 : 20 }) : e(Mic, { size: width < 768 ? 18 : 20 })
                    ),
                    e('input', { type: "text", value: inputValue, onChange: (ev) => setInputValue(ev.target.value), placeholder: `Message ${aiName}...`, disabled: isProcessing, style: { flex: 1, padding: width < 768 ? '0.7rem 1rem' : '0.75rem 1rem', border: '2px solid rgba(59, 130, 246, 0.3)', borderRadius: '12px', fontSize: width < 768 ? '0.95rem' : '1rem', outline: 'none', background: 'rgba(30, 41, 59, 0.6)', color: '#e2e8f0' } }),
                    e('button', { type: "submit", disabled: !inputValue.trim() || isProcessing, style: { background: !inputValue.trim() || isProcessing ? 'rgba(59, 130, 246, 0.3)' : 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)', color: 'white', border: 'none', padding: width < 768 ? '0.7rem 1rem' : '0.75rem 1.5rem', borderRadius: '12px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem', opacity: !inputValue.trim() || isProcessing ? 0.5 : 1 } },
                      e(Send, { size: width < 768 ? 16 : 18 }),
                      width >= 640 && e('span', {}, 'Send')
                    )
                  )
                )
              )
            ),
            showSettings && e('div', { style: { position: 'fixed', inset: 0, background: 'rgba(0, 0, 0, 0.7)', display: 'flex', alignItems: width < 768 ? 'flex-end' : 'center', justifyContent: 'center', zIndex: 1000, backdropFilter: 'blur(4px)' } },
              e('div', { style: { background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', borderRadius: width < 768 ? '20px 20px 0 0' : '16px', width: width < 768 ? '100%' : '90%', maxWidth: '600px', maxHeight: '90vh', overflow: 'hidden', display: 'flex', flexDirection: 'column', border: '1px solid rgba(59, 130, 246, 0.3)' } },
                e('div', { style: { padding: width < 768 ? '1.25rem' : '1.5rem 2rem', borderBottom: '1px solid rgba(59, 130, 246, 0.2)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)' } },
                  e('h2', { style: { margin: 0, color: 'white', fontSize: width < 768 ? '1.25rem' : '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' } }, e(Settings, { size: width < 768 ? 20 : 24 }), 'Configuration'),
                  e('button', { onClick: () => setShowSettings(false), style: { background: 'rgba(255, 255, 255, 0.2)', color: 'white', border: 'none', width: width < 768 ? '36px' : '40px', height: width < 768 ? '36px' : '40px', borderRadius: '50%', cursor: 'pointer', fontSize: '1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center' } }, '×')
                ),
                e('div', { style: { flex: 1, overflowY: 'auto', padding: width < 768 ? '1.5rem' : '2rem' } },
                  e('div', { style: { marginBottom: '1rem' } },
                    e('label', { style: { display: 'block', marginBottom: '0.5rem', color: '#cbd5e1', fontSize: width < 768 ? '0.85rem' : '0.9rem' } }, 'AI Assistant Name'),
                    e('input', { type: "text", value: aiName, onChange: (ev) => setAiName(ev.target.value), style: { width: '100%', padding: width < 768 ? '0.7rem' : '0.75rem', border: '2px solid rgba(59, 130, 246, 0.3)', borderRadius: '8px', fontSize: '1rem', background: 'rgba(30, 41, 59, 0.6)', color: '#e2e8f0', boxSizing: 'border-box' } })
                  ),
                  e('div', { style: { marginBottom: '1rem' } },
                    e('label', { style: { display: 'block', marginBottom: '0.5rem', color: '#cbd5e1', fontSize: width < 768 ? '0.85rem' : '0.9rem' } }, 'Gemini API Key'),
                    e('input', { type: "password", value: apiKey, onChange: (ev) => setApiKey(ev.target.value), style: { width: '100%', padding: width < 768 ? '0.7rem' : '0.75rem', border: '2px solid rgba(59, 130, 246, 0.3)', borderRadius: '8px', fontSize: '1rem', background: 'rgba(30, 41, 59, 0.6)', color: '#e2e8f0', boxSizing: 'border-box' } })
                  )
                ),
                e('div', { style: { padding: width < 768 ? '1rem 1.5rem' : '1.5rem 2rem', borderTop: '1px solid rgba(59, 130, 246, 0.2)', background: 'rgba(15, 23, 42, 0.95)' } },
                  e('button', { onClick: () => { setShowSettings(false); addMessage('ai', '✅ Settings saved!'); }, style: { width: '100%', background: 'linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%)', color: 'white', border: 'none', padding: '1rem', borderRadius: '12px', cursor: 'pointer', fontSize: '1rem', fontWeight: '600', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' } },
                    e(Save, { size: 20 }), 'Save Configuration'
                  )
                )
              )
            ),
            e('style', {}, `
              .spin { animation: spin 1s linear infinite; }
              @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
              input:focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
            `)
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));

        // --- End of App Code ---

      } catch (err) {
        // THIS IS THE CATCH BLOCK I FIXED. The typo 'Two-Up (Marked)' is GONE.
        document.getElementById('root').innerHTML = 
          '<div style="color: red; padding: 2rem; font-family: sans-serif;">' +
            '<h3>Application Failed to Load</h3>' +
            '<p>Error: ' + err.message + '</p>' +
            '<p>This might be due to a script failing to load. Please check your network connection and reload.</p>' +
            '<pre>' + err.stack + '</pre>' +
          '</div>';
        console.error("Application failed:", err);
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('ServiceWorker registration successful.'))
          .catch(err => console.log('ServiceWorker registration failed: ', err));
      });
    }
  </script>
</body>
</html>
